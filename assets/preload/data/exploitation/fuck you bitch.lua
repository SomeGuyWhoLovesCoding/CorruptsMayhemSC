-- The Entire Script is by @+Laztrix#8990 aka @curLazt, and @Mayo78#7878

-- Modified by @SomeGuyWhoLikesFNF#1601 aka @#FNJSWEEP

-- Original Haxe Code by Dusk: https://www.youtube.com/channel/UCVv8S6fT_4TyaJOwk5YxBFA

function opponentNoteHit(id,data,type,sus)
		if getProperty('health') * 50 > 20 then
		setProperty('health', getProperty('health') - 0.048);
		triggerEvent('Screen Shake','0.02, 0.0072','0, 0')
	end
		if getProperty('health') * 50 < 20 then
		setProperty('health', getProperty('health') + 0.048);
		triggerEvent('Screen Shake','0.02, 0.0072','0, 0')
	end
end
function onEvent(n,v1,v2)
	if n == 'Flash Event' then
		playSound('static',0.3)
	end
end
function onTweenCompleted(t)
	if t == 'blackout' then
         removeLuaSprite('blackout',false)
	end
end

function onSongStart()
	runHaxeCode([[
        windowDad = Application.current.createWindow({
			title: 'ender.xml',
			width: 1280,
			height: 1080,
			borderless: true,
			alwaysOnTop: false

        });]])
		setTransparency(0x00090909)
	runHaxeCode([[
	windowDad.stage.color = 0x00090909;
	Application.current.window.focus();
		]])
end

local window_default = {}

function onCreatePost()

	setPropertyFromClass("openfl.Lib", "application.window.title","MY WORLD BITCH")
	window_default[1] = getPropertyFromClass("openfl.Lib", "application.window.x")
	window_default[2] = getPropertyFromClass("openfl.Lib", "application.window.y")

   addHaxeLibrary('Lib', 'openfl')

   addHaxeLibrary('Application', 'openfl.display')
   addHaxeLibrary('Application', 'lime.app')
   addHaxeLibrary('KeyCode', 'lime.ui')
   addHaxeLibrary('RenderContext', 'lime.graphics')
   addHaxeLibrary('Assets', 'openfl.utils')
   
   addHaxeLibrary('KeyModifier', 'lime.ui')
   
   addHaxeLibrary('FlxG', 'flixel')
   addHaxeLibrary('Matrix', 'openfl.geom')
   addHaxeLibrary('Rectangle', 'openfl.geom')
   addHaxeLibrary('Sprite', 'openfl.display')
	
	makeLuaSprite('hella','Expunged/HELLthBar',getProperty('healthBarBG.x'),getProperty('healthBarBG.y'))
	addLuaSprite('hella')
	setObjectCamera('hella','hud')
	setObjectOrder('hella',getObjectOrder('healthBarBG'))
	setProperty('healthBarBG.visible',false)
end
function blackout(time)

	makeLuaSprite('blackout','',0,0)
	makeGraphic('blackout', 5000, 5000, 'FFFFFF')
	addLuaSprite('blackout',false)
	screenCenter('blackout','xy')
	setObjectCamera('blackout','camHUD')
    setProperty('blackout.alpha',0) 
    doTweenAlpha('blackout','blackout',1,time,'circOut')
end
local fakedefaultNotePos = {};

function onUpdatePost(elapsed)
  if curStep >= 6 then
	setProperty('iconbarAlt.x',getProperty('iconbar.x')+50)
  end
end
fr = 0
function onUpdate(elapsed)

	fr = fr + elapsed

	setPropertyFromClass("openfl.Lib", "application.window.borderless", true)

	setTransparency(0x00090909)

	triggerEvent('Change Scroll Speed', 2.5 * (1.5 / 3 - 0.15))
	
	bruhy = 52
	bruhx = (664 + math.sin(fr*1.75) * -704)

	runHaxeCode([[
        
		var dadFrame = game.dad._frame;
		
		if (dadFrame == null || dadFrame.frame == null) return;
			
		var rect = new Rectangle(dadFrame.frame.x, dadFrame.frame.y, dadFrame.frame.width, dadFrame.frame.height);

		dadWin.scrollRect = rect;
		dadWin.x = (0 + ((dadFrame.offset.x) - (game.dad.offset.x / 2)) * dadWin.scaleX);

		windowDad.x = ]]..bruhx..[[;
		windowDad.y = ]]..bruhy..[[;
		]])
end

function onStepHit()
	if curStep == 1276 then
		blackout(0.38)
	end
    if curStep == 2080 then
		doTweenWindow("x",window_default[1],0.72,"expoOut")
		doTweenWindow("y",window_default[2],0.72,"expoOut")
		runHaxeCode([[
			windowDad.y = -5000;
			
		]])
	end
	if curStep == 1280 then
	    removeLuaSprite('blackout',false)
        setProperty('dad.visible',false)
		doTweenWindow("y",window_default[2] + 128,0.72,"expoOut")
	setPropertyFromClass("openfl.Lib", "application.window.borderless", true)

    runHaxeCode([[

	Application.current.window.focus();

            windowDad.x = 0;
            windowDad.y = 52;
        dadWin = new Sprite();
        var dadScrollWin = new Sprite();
        windowDad.stage.addEventListener("keyDown", FlxG.keys.onKeyDown);
        windowDad.stage.addEventListener("keyUp", FlxG.keys.onKeyUp);
        var m = new Matrix();
        
        dadWin.graphics.beginBitmapFill(game.dad.pixels, m);
        dadWin.graphics.drawRect(0, 0, game.dad.pixels.width, game.dad.pixels.height);
        dadWin.graphics.endFill();
        windowDad.stage.addChild(dadWin);
        dadWin.scaleX = 0.5;
        dadWin.scaleY = 0.5;

    ]])
	end
	if curStep == 8 then
	setProperty('iconbar.visible',false)
		makeAnimatedLuaSprite('iconbarAlt', nil, getProperty('iconbar.x')+90, getProperty('iconbar.y')-5)
		loadGraphic('iconbarAlt', 'icons/'..getProperty('dad.healthIcon'), 150)
		addAnimation('iconbarAlt', 'icons/'..getProperty('dad.healthIcon'), {0, 1}, 0, true)
		setObjectCamera('iconbarAlt', 'camHUD')
		scaleObject('iconbarAlt',0.5,0.5)
	setObjectOrder('iconbarAlt',getObjectOrder('textsong'))
		setTextString('textsong','Song by EXPUNGED')
		scaleObject('wall',0.9,0.5)
	end
	if curStep == 14 then
		setTextString('textsong','Song by Oxygen')
		setProperty('iconbar.visible',true)
		setProperty('iconbarAlt.visible',false)
		scaleObject('wall',0.75,0.5)
	end
	if curStep == 18 then
		setTextString('textsong','Song by EXPUNGED')
		setProperty('iconbar.visible',false)
		setProperty('iconbarAlt.visible',true)
		scaleObject('wall',0.9,0.5)
	end
end

function fontchange(name)
	setTextFont('timeTxt', name)
	setTextFont('warning', name)
	setTextFont('ghudsong', name)
	setTextFont('ghudscoreTxt', name)
end
local fontlol = {'COMIC.TTF','metro.otf','vcr.ttf','Fuck You.otf'}
function onBeatHit()
	if curBeat % 0.5 == 0 then
		fontchange(fontlol[getRandomInt(1,6)])
	end
end
function doTweenWindow(var,value,duration,ease)
	runHaxeCode([[FlxTween.tween(Lib.application.window, {]]..var..[[: ]]..value..[[}, ]]..duration..[[, {ease: FlxEase.]]..ease..[[});]])
end

function killYourself()
	infectComputer()
end

function infectComputer()
	-- L
end

function onDestroy()
	setTransparency(-999)
	-- WHAT THE ACTUAL FUCK ARE YOU DOING
		-- ~ Ender Corrupt
	if not isStoryMode then
	killYourself()
	end
	setPropertyFromClass("openfl.Lib", "application.window.borderless", false)
	setPropertyFromClass('lime.app.Application', 'current.window.title', "Corrupt's Mayhem")
	setPropertyFromClass("openfl.Lib", "application.window.x",window_default[1])
	setPropertyFromClass("openfl.Lib", "application.window.y",window_default[2])
end


ffi = require "ffi"

ffi.cdef [[
    typedef int BOOL;
        typedef int BYTE;
        typedef int LONG;
        typedef LONG DWORD;
        typedef DWORD COLORREF;
    typedef unsigned long HANDLE;
    typedef HANDLE HWND;
    typedef int bInvert;
        
        HWND GetActiveWindow(void);
        
        LONG SetWindowLongA(HWND hWnd, int nIndex, LONG dwNewLong);
        
    HWND SetLayeredWindowAttributes(HWND hwnd, COLORREF crKey, BYTE bAlpha, DWORD dwFlags);
        
        DWORD GetLastError();
]]
function setTransparency(color)
    local win = ffi.C.GetActiveWindow()

    if win == nil then
        debugPrint('Error finding window!!! idiot!!!!')
        debugPrint('cool code: '..tostring(ffi.C.GetLastError()))
    end
    if ffi.C.SetWindowLongA(win, -20, 0x00080000) == 0 then
        debugPrint('error setting window to be layed WTF DFOES THAT EVBEN MEAN LMAOOO!!! IM NOT NO NERD!')
        debugPrint('cool code: '..tostring(ffi.C.GetLastError()))
    end
    if ffi.C.SetLayeredWindowAttributes(win, color, 0, 0x00000001) == 0 then
        debugPrint('error setting color key or whatever')
        debugPrint('cool code: '..tostring(ffi.C.GetLastError()))
    end
end